# Docker Quick Start

Get started with GitLab MR Summarizer using Docker in 5 minutes!

## Prerequisites

- Docker and Docker Compose installed
- Ollama running on your host machine
- GitLab personal access token
- Gmail app password

## Step-by-Step Setup

### 1. Clone and Configure

```bash
# Clone the repository (if you haven't already)
cd /path/to/experiement-mcp

# Copy the example environment file
cp .env.docker.example .env

# Edit .env with your credentials
nano .env  # or use your favorite editor
```

### 2. Edit `.env` File

Update these required values:

```env
GITLAB_TOKEN=glpat-your-actual-token-here
GMAIL_EMAIL=your.email@gmail.com
GMAIL_APP_PASSWORD=your app password here
```

Optional customization:

```env
# If using self-hosted GitLab
GITLAB_URL=https://gitlab.yourcompany.com

# If using different model
OLLAMA_MODEL=deepseek-coder

# Email check frequency (seconds)
CHECK_INTERVAL=120
```

### 3. Start Ollama

Make sure Ollama is running on your host machine:

```bash
# In a separate terminal
ollama serve

# Verify it's working
curl http://localhost:11434/api/tags
```

### 4. Build and Start Services

```bash
# Build Docker images
make docker-build

# Start all services in background
make docker-up
```

### 5. Verify Services

```bash
# Check service status
make docker-status

# Should show 4 services running:
# - gitlab-mr-summarizer-redis (healthy)
# - gitlab-mr-summarizer-gitlab (healthy)
# - gitlab-mr-summarizer-llm (healthy)
# - gitlab-mr-summarizer-client (running)

# Test health endpoints
curl http://localhost:8001/health
curl http://localhost:8002/health

# Test Redis connection
docker exec gitlab-mr-summarizer-redis redis-cli ping
```

### 6. View Logs

```bash
# View all logs in real-time
make docker-logs

# Or view specific service logs
make docker-logs-client
make docker-logs-gitlab
make docker-logs-llm
```

### 7. Test the System

Send yourself a test GitLab MR assignment email, and watch the logs:

```bash
make docker-logs-client
```

You should see:
- Email detected
- MR fetched from GitLab
- Summary generated by LLM
- Comment posted to MR

## Common Commands

```bash
# Stop all services
make docker-down

# Restart services
make docker-restart

# View service status
make docker-status

# View logs
make docker-logs           # All services
make docker-logs-client    # Just client
make docker-logs-gitlab    # Just GitLab server
make docker-logs-llm       # Just LLM server

# Rebuild after code changes
make docker-build
make docker-restart

# Clean up everything
make docker-clean
```

## Architecture

```
┌─────────────────────────────────────┐
│  Host Machine                        │
│                                      │
│  ┌─────────────┐                    │
│  │   Ollama    │                    │
│  │  :11434     │◄───────────┐      │
│  └─────────────┘            │      │
│                              │      │
│  ┌──────────────────────────┼──┐   │
│  │  Docker Network          │  │   │
│  │                          │  │   │
│  │  ┌──────────────┐        │  │   │
│  │  │gitlab-server │:8001   │  │   │
│  │  │   (FastAPI)  │        │  │   │
│  │  └──────▲───────┘        │  │   │
│  │         │                │  │   │
│  │  ┌──────┴───────┐        │  │   │
│  │  │  llm-server  │:8002───┘  │   │
│  │  │   (FastAPI)  │           │   │
│  │  └──────▲───────┘           │   │
│  │         │                   │   │
│  │  ┌──────┴───────┐           │   │
│  │  │    client    │           │   │
│  │  │ (Email Mon.) │           │   │
│  │  └──────────────┘           │   │
│  └──────────────────────────────┘   │
└─────────────────────────────────────┘
```

## Troubleshooting

### Services won't start

```bash
# Check logs for errors
make docker-logs

# Common issues:
# - Missing .env file
# - Invalid GitLab token
# - Gmail authentication failure
```

### Can't connect to Ollama

**Error**: Connection refused to Ollama

**Solution**:
1. Ensure Ollama is running: `ollama serve`
2. Verify `OLLAMA_BASE_URL=http://host.docker.internal:11434` in `.env`
3. On Linux, use your actual host IP instead of `host.docker.internal`

### Services keep restarting

```bash
# Check individual service logs
make docker-logs-client

# Verify all required env vars are set
docker-compose config
```

### Health checks failing

```bash
# Test health endpoints manually
curl http://localhost:8001/health
curl http://localhost:8002/health

# Should return: {"status": "healthy", ...}
```

### No emails being detected

Check client logs:

```bash
make docker-logs-client
```

Look for:
- "Found N GitLab emails since..."
- "Checking email: ..."
- Make sure emails are from last 24 hours

## Environment Variables Reference

### Required
- `GITLAB_TOKEN` - Your GitLab personal access token
- `GMAIL_EMAIL` - Your Gmail address
- `GMAIL_APP_PASSWORD` - Gmail app-specific password

### Optional
- `GITLAB_URL` - GitLab instance URL (default: https://gitlab.com)
- `GITLAB_FROM_EMAIL` - GitLab notification sender (default: gitlab@mg.gitlab.com)
- `GITLAB_SERVER_URL` - Internal GitLab API URL (default: http://gitlab-server:8001)
- `LLM_SERVER_URL` - Internal LLM API URL (default: http://llm-server:8002)
- `REDIS_URL` - Redis connection URL (default: redis://redis:6379/0)
- `USE_REDIS` - Use Redis for storage (default: true in Docker)
- `OLLAMA_BASE_URL` - Ollama API URL (default: http://host.docker.internal:11434)
- `OLLAMA_MODEL` - LLM model to use (default: codellama)
- `CHECK_INTERVAL` - Email check frequency in seconds (default: 60)
- `LOG_LEVEL` - Logging level (default: INFO)
- `MR_STATES_TO_PROCESS` - MR states to process (default: opened)
- `MAX_FILES_IN_PROMPT` - Max files in prompt (default: 999999)
- `MAX_DIFF_LINES_PER_FILE` - Max diff lines per file (default: 999999)

## Next Steps

- Read [DOCKER.md](DOCKER.md) for advanced Docker usage
- Read [README.md](README.md) for complete documentation
- Check [IMPLEMENTATION_COMPLETE.md](IMPLEMENTATION_COMPLETE.md) for technical details

## Support

If you encounter issues:
1. Check the troubleshooting section above
2. View logs: `make docker-logs`
3. Verify configuration: `docker-compose config`
4. Test health endpoints: `curl http://localhost:8001/health`

